<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apollo - Labs</title>
  <link rel="icon" type="image/png" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/apollo-5ls5iKKPFmglazvYUE7bAbEzQO1eqP.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #1e40af;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --border-radius: 16px;
      --box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .dark-mode {
      --primary: #60a5fa;
      --primary-dark: #3b82f6;
      --secondary: #1d4ed8;
      --success: #34d399;
      --danger: #f87171;
      --warning: #fbbf24;
      --light: #1e293b;
      --dark: #e2e8f0;
      --gray: #94a3b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--dark);
      transition: var(--transition);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
    }

    .dark-mode body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--dark);
    }

    /* Animated background particles */
    .bg-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      position: relative;
    }

    /* Enhanced Navigation */
    .nav-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 1.5rem 2.5rem;
      margin-bottom: 3rem;
      box-shadow: var(--box-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transform: translateY(0);
      animation: slideDown 0.8s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .dark-mode .nav-container {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 2rem;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
      transition: var(--transition);
    }

    .nav-brand:hover {
      transform: scale(1.05);
    }

    .nav-brand i {
      font-size: 2.5rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: pulse 2s infinite;
    }

    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      background: rgba(0, 0, 0, 0.05);
      padding: 0.5rem;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .dark-mode .nav-tabs {
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-tab {
      padding: 1rem 2rem;
      border: none;
      background: transparent;
      color: var(--gray);
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient-primary);
      transition: var(--transition);
      z-index: -1;
    }

    .nav-tab.active::before,
    .nav-tab:hover::before {
      left: 0;
    }

    .nav-tab.active,
    .nav-tab:hover {
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .nav-controls {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .admin-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
    }

    .admin-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient-secondary);
      transition: var(--transition);
      z-index: -1;
    }

    .admin-btn:hover::before {
      left: 0;
    }

    .admin-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--dark);
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .theme-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-primary);
      border-radius: 50%;
      opacity: 0;
      transition: var(--transition);
      z-index: -1;
    }

    .theme-toggle:hover::before {
      opacity: 0.2;
    }

    .theme-toggle:hover {
      transform: rotate(180deg) scale(1.1);
      color: var(--primary);
    }

    /* Enhanced Main Content */
    .main-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
      animation: fadeInUp 1s ease-out 0.3s both;
    }

    @keyframes fadeInUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .dark-mode .main-content {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .content-header {
      padding: 3rem;
      background: var(--gradient-primary);
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .content-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .content-header h1 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 1rem;
      position: relative;
      z-index: 1;
    }

    .content-header p {
      font-size: 1.25rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .content-body {
      padding: 3rem;
    }

    /* Enhanced Search Container */
    .search-container {
      position: relative;
      margin-bottom: 3rem;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }

    .search-input {
      width: 100%;
      padding: 1.5rem 1.5rem 1.5rem 4rem;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--border-radius);
      color: var(--dark);
      font-size: 1.1rem;
      transition: var(--transition);
      box-shadow: var(--box-shadow);
    }

    .dark-mode .search-input {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(96, 165, 250, 0.3);
      color: var(--dark);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), var(--box-shadow);
      transform: translateY(-3px);
    }

    .search-icon {
      position: absolute;
      left: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      pointer-events: none;
      font-size: 1.2rem;
    }

    /* Enhanced Product Sections */
    .product-section {
      margin-bottom: 3rem;
      animation: fadeInUp 0.8s ease-out;
    }

    .product-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding: 2rem 2.5rem;
      background: var(--gradient-primary);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
    }

    .product-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 15s linear infinite reverse;
    }

    .product-icon {
      font-size: 2rem;
      position: relative;
      z-index: 1;
    }

    .product-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0;
      position: relative;
      z-index: 1;
    }

    .product-count {
      margin-left: auto;
      background: rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }

    /* Enhanced Labs Grid */
    .labs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .lab-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--border-radius);
      padding: 2rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }

    .dark-mode .lab-card {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .lab-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: var(--gradient-primary);
      transform: scaleY(0);
      transition: var(--transition);
    }

    .lab-card:hover::before {
      transform: scaleY(1);
    }

    .lab-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      border-color: var(--primary);
    }

    .lab-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .lab-info {
      color: var(--gray);
      font-size: 1rem;
      margin-bottom: 0.75rem;
      font-weight: 500;
    }

    .lab-owner {
      color: var(--dark);
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Enhanced Lab Details */
    .lab-details {
      display: none;
      animation: fadeIn 0.6s ease;
    }

    .lab-details.active {
      display: block;
    }

    .back-btn {
      background: var(--gradient-secondary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      margin-bottom: 3rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: var(--box-shadow);
    }

    .back-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    .lab-section {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--border-radius);
      padding: 2.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--box-shadow);
    }

    .dark-mode .lab-section {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .portals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .portal-card {
      background: rgba(59, 130, 246, 0.05);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .portal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient-success);
      opacity: 0.1;
      transition: var(--transition);
      z-index: -1;
    }

    .portal-card:hover::before {
      left: 0;
    }

    .portal-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .portal-name {
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
    }

    .portal-url {
      font-size: 0.95rem;
      color: var(--gray);
      margin-bottom: 1rem;
      word-break: break-all;
      font-family: 'JetBrains Mono', monospace;
    }

    .portal-actions {
      display: flex;
      gap: 0.75rem;
    }

    .portal-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .portal-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .portal-btn.secondary {
      background: var(--gray);
    }

    .portal-btn.secondary:hover {
      background: var(--dark);
    }

    .credentials {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      margin-top: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .dark-mode .credentials {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .nodes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .node-card {
      background: rgba(16, 185, 129, 0.05);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .node-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient-success);
      opacity: 0.1;
      transition: var(--transition);
      z-index: -1;
    }

    .node-card:hover::before {
      left: 0;
    }

    .node-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .node-type {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--success);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
    }

    .node-name {
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
    }

    .node-os {
      color: var(--warning);
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }

    .node-ip {
      font-size: 0.95rem;
      color: var(--gray);
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 0.75rem;
    }

    /* Enhanced Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 5rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
      opacity: 0.5;
      animation: pulse 2s infinite;
    }

    .empty-state h3 {
      font-size: 1.75rem;
      margin-bottom: 1rem;
      color: var(--dark);
      font-weight: 700;
    }

    .empty-state p {
      font-size: 1.1rem;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    /* Enhanced Loading */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }

    .loading.show {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Pulse animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .nav-header {
        flex-direction: column;
        align-items: stretch;
      }

      .nav-tabs {
        justify-content: center;
      }

      .content-header h1 {
        font-size: 2.5rem;
      }

      .content-body {
        padding: 2rem;
      }

      .labs-grid {
        grid-template-columns: 1fr;
      }

      .portals-grid {
        grid-template-columns: 1fr;
      }

      .nodes-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .product-header {
        padding: 1.5rem;
        flex-direction: column;
        text-align: center;
      }

      .product-count {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Animated background particles -->
  <div class="bg-particles" id="bgParticles"></div>

  <div class="container">
    <!-- Navigation -->
    <div class="nav-container">
      <div class="nav-header">
        <a href="/" class="nav-brand">
          <i class="fas fa-brain"></i>
          Apollo
        </a>
        
        <div class="nav-tabs">
          <a href="/" class="nav-tab">
            <i class="fas fa-database"></i>
            Knowledge Base
          </a>
          <a href="/labs" class="nav-tab active">
            <i class="fas fa-flask"></i>
            Labs
          </a>
        </div>

        <div class="nav-controls">
          <a href="/admin" class="admin-btn" id="adminBtn">
            <i class="fas fa-cog"></i>
            Admin
          </a>
          <button id="themeToggle" class="theme-toggle">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="content-header">
        <h1><i class="fas fa-flask"></i> Lab Environments</h1>
        <p>If any of the labs is down, please contact the Owner mentioned for the environment</p>
      </div>
      
      <div class="content-body">
        <!-- Search Container -->
        <div class="search-container">
          <i class="search-icon fas fa-search"></i>
          <input type="text" id="searchInput" class="search-input" placeholder="Search labs by name, owner, or product...">
        </div>

        <!-- Labs List View -->
        <div id="labsList" class="labs-view">
          <div id="labsContainer">
            <!-- Labs will be loaded here grouped by product -->
          </div>
          
          <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-flask"></i>
            <h3>No Labs Available</h3>
            <p>Contact your administrator to set up lab environments.</p>
          </div>
        </div>

        <!-- Lab Details View -->
        <div id="labDetails" class="lab-details">
          <button id="backToLabs" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Labs
          </button>

          <div id="labDetailsContent">
            <!-- Lab details will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
  </div>

  <script>
    // Create animated background particles
    function createParticles() {
      const particlesContainer = document.getElementById('bgParticles');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        
        const size = Math.random() * 4 + 2;
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * window.innerHeight;
        const delay = Math.random() * 6;
        
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.animationDelay = delay + 's';
        
        particlesContainer.appendChild(particle);
      }
    }

    // Check if user is authenticated
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/user');
        const data = await response.json();
        
        if (!data.authenticated) {
          window.location.href = '/login';
        } else {
          // Show admin button only for admin users
          const adminBtn = document.getElementById('adminBtn');
          if (data.user.role !== 'admin') {
            adminBtn.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = '/login';
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      createParticles();
    });

    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    const htmlElement = document.documentElement;
    
    if (localStorage.getItem('darkMode') === 'true') {
      htmlElement.classList.add('dark-mode');
      themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    themeToggle.addEventListener('click', () => {
      htmlElement.classList.toggle('dark-mode');
      const isDarkMode = htmlElement.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      
      themeToggle.innerHTML = isDarkMode 
        ? '<i class="fas fa-sun"></i>' 
        : '<i class="fas fa-moon"></i>';
    });

    // Loading indicator
    function showLoading() {
      document.getElementById('loading').classList.add('show');
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }

    // View management
    const labsList = document.getElementById('labsList');
    const labDetails = document.getElementById('labDetails');
    const backToLabs = document.getElementById('backToLabs');

    function showLabsList() {
      labDetails.classList.remove('active');
      labsList.style.display = 'block';
    }

    function showLabDetails() {
      labsList.style.display = 'none';
      labDetails.classList.add('active');
    }

    backToLabs.addEventListener('click', showLabsList);

    // Enhanced search functionality with debouncing
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    let allLabs = [];
    let searchCache = new Map();

    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      const query = searchInput.value.trim();
      
      if (query.length === 0) {
        displayLabs(allLabs);
        return;
      }
      
      if (query.length < 2) {
        return;
      }
      
      // Check cache first
      if (searchCache.has(query.toLowerCase())) {
        displayLabs(searchCache.get(query.toLowerCase()));
        return;
      }
      
      searchTimeout = setTimeout(() => {
        searchLabs(query);
      }, 200); // Reduced debounce time for faster response
    });

    async function searchLabs(query) {
      try {
        showLoading();
        const response = await fetch(`/api/labs/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        // Cache the results
        searchCache.set(query.toLowerCase(), data.labs);
        
        displayLabs(data.labs);
      } catch (error) {
        console.error('Error searching labs:', error);
      } finally {
        hideLoading();
      }
    }

    // Product configuration with enhanced colors
    const productConfig = {
      'SMAX': { icon: 'fas fa-server', color: '#667eea' },
      'SM': { icon: 'fas fa-cogs', color: '#4facfe' },
      'SMA-SM': { icon: 'fas fa-network-wired', color: '#f093fb' },
      'AM': { icon: 'fas fa-chart-line', color: '#ff6b6b' },
      'CIT': { icon: 'fas fa-shield-alt', color: '#a8edea' },
      'SMAX & CMS': { icon: 'fas fa-layer-group', color: '#ffecd2' }
    };

    const productOrder = ['SMAX', 'SM', 'SMA-SM', 'AM', 'CIT', 'SMAX & CMS'];

    // Load labs on page load
    window.addEventListener('load', loadLabs);

    async function loadLabs() {
      try {
        showLoading();
        const response = await fetch('/api/admin/labs');
        const data = await response.json();
        
        allLabs = data.labs || [];
        displayLabs(allLabs);
      } catch (error) {
        console.error('Error loading labs:', error);
        showEmptyState();
      } finally {
        hideLoading();
      }
    }

    function displayLabs(labs) {
      const labsContainer = document.getElementById('labsContainer');
      const emptyState = document.getElementById('emptyState');
      
      if (!labs || labs.length === 0) {
        showEmptyState();
        return;
      }
      
      emptyState.style.display = 'none';
      
      // Group labs by product
      const groupedLabs = {};
      labs.forEach(lab => {
        const product = lab.product || 'Other';
        if (!groupedLabs[product]) {
          groupedLabs[product] = [];
        }
        groupedLabs[product].push(lab);
      });
      
      labsContainer.innerHTML = '';
      
      // Display products in specified order
      productOrder.forEach(product => {
        if (groupedLabs[product] && groupedLabs[product].length > 0) {
          createProductSection(product, groupedLabs[product], labsContainer);
          delete groupedLabs[product];
        }
      });
      
      // Display remaining products
      Object.keys(groupedLabs).forEach(product => {
        if (groupedLabs[product].length > 0) {
          createProductSection(product, groupedLabs[product], labsContainer);
        }
      });
    }

    function createProductSection(product, labs, container) {
      const config = productConfig[product] || { icon: 'fas fa-server', color: '#64748b' };
      
      const section = document.createElement('div');
      section.className = 'product-section';
      
      section.innerHTML = `
        <div class="product-header" style="background: linear-gradient(135deg, ${config.color} 0%, ${adjustColor(config.color, -20)} 100%);">
          <i class="product-icon ${config.icon}"></i>
          <h2 class="product-title">${product}</h2>
          <span class="product-count">${labs.length} lab${labs.length !== 1 ? 's' : ''}</span>
        </div>
        <div class="labs-grid" id="grid-${product.replace(/\s+/g, '-')}">
        </div>
      `;
      
      container.appendChild(section);
      
      const grid = section.querySelector('.labs-grid');
      labs.forEach((lab, index) => {
        const labCard = createLabCard(lab);
        // Add staggered animation delay
        labCard.style.animationDelay = `${index * 0.1}s`;
        grid.appendChild(labCard);
      });
    }

    function createLabCard(lab) {
      const card = document.createElement('div');
      card.className = 'lab-card';
      card.onclick = () => loadLabDetails(lab.id);
      
      card.innerHTML = `
        <div class="lab-name">
          <i class="fas fa-server"></i>
          ${lab.name}
        </div>
        <div class="lab-info">Lab Environment</div>
        <div class="lab-owner">
          <i class="fas fa-user"></i>
          ${lab.owner || 'No owner specified'}
        </div>
      `;
      
      return card;
    }

    function adjustColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    function showEmptyState() {
      document.getElementById('labsContainer').innerHTML = '';
      document.getElementById('emptyState').style.display = 'block';
    }

    async function loadLabDetails(labId) {
      try {
        showLoading();
        const response = await fetch(`/api/admin/labs/${labId}`);
        const data = await response.json();
        
        displayLabDetails(data);
        showLabDetails();
      } catch (error) {
        console.error('Error loading lab details:', error);
      } finally {
        hideLoading();
      }
    }

    function displayLabDetails(data) {
      const { lab, portals, nodes } = data;
      const detailsContent = document.getElementById('labDetailsContent');
      
      let portalsHtml = '';
      if (portals && portals.length > 0) {
        const sortedPortals = portals.sort((a, b) => {
          const order = ['Service Portal', 'Back Office', '5443 Portal'];
          const indexA = order.indexOf(a.name);
          const indexB = order.indexOf(b.name);
          if (indexA !== -1 && indexB !== -1) return indexA - indexB;
          if (indexA !== -1) return -1;
          if (indexB !== -1) return 1;
          return a.name.localeCompare(b.name);
        });

        portalsHtml = `
          <div class="lab-section">
            <h3 class="section-title">
              <i class="fas fa-globe"></i>
              Portals
            </h3>
            <div class="portals-grid">
              ${sortedPortals.map(portal => `
                <div class="portal-card">
                  <div class="portal-name">${portal.name}</div>
                  <div class="portal-url">${portal.url}</div>
                  <div class="portal-actions">
                    <button class="portal-btn" onclick="window.open('${portal.url}', '_blank')">
                      <i class="fas fa-external-link-alt"></i>
                      Open
                    </button>
                  </div>
                  ${(portal.username || portal.password) ? `
                    <div class="credentials">
                      ${portal.username ? `<div><strong>Username:</strong> ${portal.username}</div>` : ''}
                      ${portal.password ? `<div><strong>Password:</strong> ${portal.password}</div>` : ''}
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      let nodesHtml = '';
      if (nodes && nodes.length > 0) {
        // Group nodes by type
        const groupedNodes = {};
        nodes.forEach(node => {
          if (!groupedNodes[node.type]) {
            groupedNodes[node.type] = [];
          }
          groupedNodes[node.type].push(node);
        });

        const nodeTypeOrder = ['master', 'worker', 'nfs-db'];
        const sortedNodeTypes = Object.keys(groupedNodes).sort((a, b) => {
          const indexA = nodeTypeOrder.indexOf(a);
          const indexB = nodeTypeOrder.indexOf(b);
          if (indexA !== -1 && indexB !== -1) return indexA - indexB;
          if (indexA !== -1) return -1;
          if (indexB !== -1) return 1;
          return a.localeCompare(b);
        });

        nodesHtml = `
          <div class="lab-section">
            <h3 class="section-title">
              <i class="fas fa-network-wired"></i>
              Infrastructure Nodes
            </h3>
            ${sortedNodeTypes.map(nodeType => `
              <div style="margin-bottom: 2rem;">
                <h4 style="color: var(--success); margin-bottom: 1rem; text-transform: capitalize; font-size: 1.25rem; font-weight: 700;">
                  <i class="fas fa-server" style="margin-right: 0.5rem;"></i>
                  ${getNodeTypeDisplayName(nodeType)} Nodes
                </h4>
                <div class="nodes-grid">
                  ${groupedNodes[nodeType].map(node => `
                    <div class="node-card">
                      <div class="node-type">${getNodeTypeDisplayName(nodeType)}</div>
                      <div class="node-name">${node.name}</div>
                      ${node.os ? `<div class="node-os"><i class="fas fa-desktop"></i>${node.os}</div>` : ''}
                      ${node.ip_address ? `<div class="node-ip">${node.ip_address}</div>` : ''}
                      ${(node.username || node.password) ? `
                        <div class="credentials">
                          ${node.username ? `<div><strong>User:</strong> ${node.username}</div>` : ''}
                          ${node.password ? `<div><strong>Pass:</strong> ${node.password}</div>` : ''}
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      detailsContent.innerHTML = `
        <div class="lab-section">
          <h2 style="color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; font-size: 2.25rem;">
            <i class="fas fa-server"></i>
            ${lab.name}
          </h2>
          <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            ${lab.owner ? `
              <div style="color: var(--gray); font-size: 1.1rem;">
                <i class="fas fa-user" style="margin-right: 0.5rem;"></i>
                Owner: ${lab.owner}
              </div>
            ` : ''}
            <div style="background: var(--gradient-primary); color: white; padding: 0.5rem 1rem; border-radius: 25px; font-size: 1rem; font-weight: 600;">
              ${lab.product}
            </div>
          </div>
        </div>
        ${portalsHtml}
        ${nodesHtml}
      `;
    }

    function getNodeTypeDisplayName(type) {
      switch (type) {
        case 'nfs-db':
          return 'NFS/DB';
        default:
          return type.charAt(0).toUpperCase() + type.slice(1);
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Show a temporary success message
        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<i class="fas fa-check"></i> Copied!';
        event.target.style.background = 'var(--success)';
        
        setTimeout(() => {
          event.target.innerHTML = originalText;
          event.target.style.background = '';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy: ', err);
      });
    }
  </script>
</body>
</html>
